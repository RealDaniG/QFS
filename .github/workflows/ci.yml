name: QFS V13 CI Pipeline
# Consolidated pipeline for Zero-Simulation, PQC security, and Determinism
# IMPROVED: Structured logging, fail-fast, minimal permissions

on:
  push:
    branches: [main, develop, fix/*, phase*]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.11"
  COVERAGE_THRESHOLD: 100
  # MOCKQPC Environment (Contract § 2.6, § 4.4)
  ENV: "dev"
  MOCKQPC_ENABLED: "true"
  CI: "true"

permissions:
  contents: read
  actions: read

jobs:
  # ============================================================================
  # Stage 1: Static Analysis
  # ============================================================================
  static-analysis:
    name: "[STAGE 1] Static Analysis & Zero-Sim Check"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "[SETUP] Install dependencies"
        run: |
          set -euo pipefail
          echo "::group::Installing Dependencies"
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pylint black isort mypy bandit semgrep
          echo "::endgroup::"

      - name: "[SETUP] Deterministic Environment Build"
        run: |
          set -euo pipefail
          echo "::group::Environment Verification"
          echo "Python version: $(python --version)"
          echo "Pip version: $(pip --version)"
          pip freeze > build_environment.txt
          echo "::endgroup::"

      - name: "[ZERO-SIM] Run Analyzer (Strict Enforcement)"
        id: zero-sim-check
        run: |
          set -euo pipefail
          echo "::group::Zero-Sim Analysis"
          START_TIME=$(date +%s)

          python v13/scripts/zero_sim_analyzer.py \
            --dir v13 \
            --exclude legacy_root node_modules \
            --output violation_report.json

          END_TIME=$(date +%s)
          echo "Duration: $((END_TIME - START_TIME))s"
          echo "::endgroup::"

      - name: "[ZERO-SIM] Check Violations & Print Summary"
        run: |
          set -euo pipefail
          python - << 'EOF'
          import json
          import sys

          data = json.load(open("violation_report.json"))
          total = data.get("total_violations", 0)

          print("\n" + "="*60)
          print("ZERO-SIM COMPLIANCE SUMMARY")
          print("="*60)
          print(f"Total Violations: {total}")

          by_category = data.get("by_category", {})
          if by_category:
              print("\nBy Category:")
              for category, count in sorted(by_category.items()):
                  print(f"  {category}: {count}")

          by_severity = data.get("by_severity", {})
          if by_severity:
              print("\nBy Severity:")
              for severity, count in sorted(by_severity.items()):
                  print(f"  {severity}: {count}")

          print("="*60 + "\n")

          if total > 0:
              print(f"❌ Zero-Simulation violations detected: {total}")
              print("See violation_report.json for details")
              sys.exit(1)

          print("✅ No Zero-Sim violations found")
          EOF

      - name: "[LINT] Pylint Check (Advisory)"
        continue-on-error: true
        run: |
          set -euo pipefail
          echo "::group::Pylint Analysis"
          START_TIME=$(date +%s)

          pylint v13/ --rcfile=pyproject.toml --fail-under=8.0 || true

          END_TIME=$(date +%s)
          echo "Duration: $((END_TIME - START_TIME))s"
          echo "::endgroup::"

      - name: "[SECURITY] Static Scan (Required)"
        run: |
          set -euo pipefail
          echo "::group::Security Scanning"
          START_TIME=$(date +%s)

          bandit -r v13/ -f json -o bandit_report.json --severity-level medium
          semgrep --config=auto v13/ --json -o semgrep_report.json --error

          END_TIME=$(date +%s)
          echo "Duration: $((END_TIME - START_TIME))s"
          echo "::endgroup::"

      - name: "[ARTIFACTS] Upload Analysis Reports"
        if: always()
        uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 # v4.3.0
        with:
          name: static-analysis-reports
          path: |
            violation_report.json
            bandit_report.json
            semgrep_report.json
            build_environment.txt
          retention-days: 30

  # ============================================================================
  # Stage 1.25: MOCKQPC + Zero-Sim Compliance
  # ============================================================================
  mockqpc-compliance:
    name: "[STAGE 1.25] MOCKQPC + Zero-Sim Compliance"
    needs: static-analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "[SETUP] Install dependencies"
        run: |
          set -euo pipefail
          echo "::group::Installing Dependencies"
          pip install --upgrade pip
          pip install -r requirements.txt
          echo "::endgroup::"

      - name: "[MOCKQPC] Run Zero-Sim + MOCKQPC Checker"
        id: mockqpc-check
        run: |
          set -euo pipefail
          echo "::group::MOCKQPC Compliance Check"
          START_TIME=$(date +%s)

          python scripts/check_zero_sim.py \
            --dir v15 \
            --output mockqpc_compliance_report.json \
            --fail-on-critical

          END_TIME=$(date +%s)
          echo "Duration: $((END_TIME - START_TIME))s"
          echo "::endgroup::"

      - name: "[MOCKQPC] Determinism Verification"
        run: |
          set -euo pipefail
          echo "::group::MOCKQPC Determinism Test"

          python scripts/verify_mockqpc_determinism.py

          echo "::endgroup::"

      - name: "[MOCKQPC] Verify Environment Variables"
        run: |
          set -euo pipefail
          echo "::group::Environment Verification"

          echo "Checking environment variables..."
          if [ "$ENV" != "dev" ]; then
            echo "❌ ENV must be 'dev' in CI, got: $ENV"
            exit 1
          fi

          if [ "$MOCKQPC_ENABLED" != "true" ]; then
            echo "❌ MOCKQPC_ENABLED must be 'true' in CI, got: $MOCKQPC_ENABLED"
            exit 1
          fi

          if [ "$CI" != "true" ]; then
            echo "❌ CI must be 'true', got: $CI"
            exit 1
          fi

          echo "✅ Environment variables correct:"
          echo "   ENV=$ENV"
          echo "   MOCKQPC_ENABLED=$MOCKQPC_ENABLED"
          echo "   CI=$CI"

          echo "::endgroup::"

      - name: "[MOCKQPC] Run Crypto Adapter Tests"
        run: |
          set -euo pipefail
          echo "::group::Crypto Adapter Test Execution"

          python -m pytest v15/tests/test_crypto_adapter.py -v --tb=short
          python -m pytest v15/tests/test_mockqpc.py -v --tb=short

          echo "::endgroup::"

      - name: "[ARTIFACTS] Upload MOCKQPC Reports"
        if: always()
        uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 # v4.3.0
        with:
          name: mockqpc-compliance-reports
          path: |
            mockqpc_compliance_report.json
          retention-days: 30

  # ============================================================================
  # Stage 1.5: Autonomous Validation
  # ============================================================================
  autonomous-validation:
    name: "[STAGE 1.5] Autonomous Validation"
    needs: [static-analysis, mockqpc-compliance]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "[SETUP] Install dependencies"
        run: |
          set -euo pipefail
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: "[AUTONOMOUS] Run Validation Harness"
        run: |
          set -euo pipefail
          echo "::group::Autonomous Constitutional Check"

          # Run the master controller
          python v13/tests/autonomous/run_autonomous_validation.py

          echo "::endgroup::"

      - name: "[ARTIFACTS] Upload Validation Logs"
        if: always()
        uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 # v4.3.0
        with:
          name: autonomous-validation-logs
          path: logs/autonomous/
          retention-days: 30

  # ============================================================================
  # Stage 2: Unit Tests
  # ============================================================================
  unit-tests:
    name: "[STAGE 2] Unit Tests"
    needs: [static-analysis, autonomous-validation]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "[SETUP] Install dependencies"
        run: |
          set -euo pipefail
          echo "::group::Installing Dependencies"
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov hypothesis
          echo "::endgroup::"

      - name: "[TESTS] Run Unit Tests"
        run: |
          set -euo pipefail
          echo "::group::Unit Test Execution"
          START_TIME=$(date +%s)

          python -m pytest v13/tests/unit/ \
            -v \
            --tb=long \
            --log-cli-level=DEBUG \
            --cov=v13 \
            --cov-report=xml:coverage.xml \
            --cov-report=term \
            --junitxml=test-results.xml

          END_TIME=$(date +%s)
          echo "Duration: $((END_TIME - START_TIME))s"
          echo "::endgroup::"

      - name: "[TESTS] Print Test Summary"
        if: always()
        run: |
          set -euo pipefail
          python - << 'EOF'
          import xml.etree.ElementTree as ET

          try:
              tree = ET.parse("test-results.xml")
              root = tree.getroot()
              
              tests = int(root.attrib.get("tests", 0))
              failures = int(root.attrib.get("failures", 0))
              errors = int(root.attrib.get("errors", 0))
              skipped = int(root.attrib.get("skipped", 0))
              
              print("\n" + "="*60)
              print("UNIT TEST SUMMARY")
              print("="*60)
              print(f"Total Tests: {tests}")
              print(f"Passed: {tests - failures - errors - skipped}")
              print(f"Failed: {failures}")
              print(f"Errors: {errors}")
              print(f"Skipped: {skipped}")
              print("="*60 + "\n")
          except Exception as e:
              print(f"Could not parse test results: {e}")
          EOF

      - name: "[ARTIFACTS] Upload Test Results"
        if: always()
        uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 # v4.3.0
        with:
          name: unit-test-results
          path: |
            coverage.xml
            test-results.xml
            v13/evidence/logs/
          retention-days: 30

  # ============================================================================
  # Stage 3: Determinism Fuzzer (Phase 3)
  # ============================================================================
  determinism-fuzzer:
    name: "[STAGE 3] Deterministic Replay Verification"
    needs: unit-tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "[SETUP] Install dependencies"
        run: |
          set -euo pipefail
          echo "::group::Installing Dependencies"
          pip install --upgrade pip
          pip install -r requirements.txt
          echo "::endgroup::"

      - name: "[DETERMINISM] Run Fuzzer (Required)"
        run: |
          set -euo pipefail
          echo "::group::Determinism Verification"
          START_TIME=$(date +%s)

          # Check for phase3 verification suite
          if [ -f "tests/phase3_verification_suite.py" ]; then
            python tests/phase3_verification_suite.py
          elif [ -f "v13/tests/phase3_verification_suite.py" ]; then
            python v13/tests/phase3_verification_suite.py
          elif [ -f "v13/tests/regression/phase_v14_social_full.py" ]; then
            # Use v14 regression as determinism check
            python v13/tests/regression/phase_v14_social_full.py > /dev/null
            echo "✅ v14 regression scenario executed successfully"
          else
            echo "❌ No determinism verification suite found"
            echo "Expected: tests/phase3_verification_suite.py or v13/tests/regression/phase_v14_social_full.py"
            exit 1
          fi

          END_TIME=$(date +%s)
          echo "Duration: $((END_TIME - START_TIME))s"
          echo "::endgroup::"

  # ============================================================================
  # Stage 4: Integration & PQC
  # ============================================================================
  integration-tests:
    name: "[STAGE 4] Integration & PQC Verification"
    needs: determinism-fuzzer
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "[SETUP] Install dependencies"
        run: |
          set -euo pipefail
          echo "::group::Installing Dependencies"
          pip install --upgrade pip
          pip install -r requirements.txt
          echo "::endgroup::"

      - name: "[INTEGRATION] Run Integration Tests"
        run: |
          set -euo pipefail
          echo "::group::Integration Test Execution"
          START_TIME=$(date +%s)

          python -m pytest v13/tests/integration/ -v --tb=short

          END_TIME=$(date +%s)
          echo "Duration: $((END_TIME - START_TIME))s"
          echo "::endgroup::"

      - name: "[PQC] Run PQC Verification"
        run: |
          set -euo pipefail
          echo "::group::PQC Verification"

          if [ -f "v13/tests/test_pqc.py" ]; then
            python -m pytest v13/tests/test_pqc.py -v
            echo "✅ PQC verification passed"
          else
            echo "⚠️ PQC verification test not found, skipping"
          fi

          echo "::endgroup::"

      - name: "[DETERMINISM] Run Replay Test"
        run: |
          set -euo pipefail
          echo "::group::Deterministic Replay Test"

          if [ -f "v13/tests/test_deterministic_replay.py" ]; then
            python v13/tests/test_deterministic_replay.py
            echo "✅ Deterministic replay test passed"
          else
            echo "⚠️ Deterministic replay test not found, skipping"
          fi

          echo "::endgroup::"
