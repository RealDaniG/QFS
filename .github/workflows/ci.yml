name: QFS V13 CI Pipeline
# Consolidated pipeline for Zero-Simulation, PQC security, and Determinism

on:
  push:
    branches: [main, develop, fix/*, phase*]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.11"
  COVERAGE_THRESHOLD: 100

jobs:
  # ============================================================================
  # Stage 1: Static Analysis
  # ============================================================================
  static-analysis:
    name: Static Analysis & Zero-Sim Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pylint black isort mypy bandit semgrep

      - name: Step 1 - Deterministic Environment Build
        run: |
          # Verify deterministic build environment
          echo "Python version: $(python --version)"
          echo "Pip version: $(pip --version)"
          pip freeze > build_environment.txt

      - name: Run Zero-Sim Analyzer (Strict Enforcement)
        id: zero-sim-check
        run: |
          # Using analyzer with strict filtering for critical categories
          python v13/scripts/zero_sim_analyzer.py --dir v13 --exclude legacy_root node_modules --output violation_report.json
          # Check if violations were found
          VIOLATION_COUNT=$(python -c "import json; data=json.load(open('violation_report.json')); print(data.get('total_violations', 0))")
          if [ "$VIOLATION_COUNT" -gt "0" ]; then
            echo "❌ Zero-Simulation violations detected: $VIOLATION_COUNT"
            echo "See violation_report.json for details"
            exit 1
          fi
          echo "✅ No Zero-Sim violations found"

      - name: Lint Check (Required)
        run: |
          # Lint is now required for production readiness
          pylint v13/ --rcfile=pyproject.toml --fail-under=8.0

      - name: Security Static Scan (Required)
        run: |
          # Security scans are now required
          bandit -r v13/ -f json -o bandit_report.json --severity-level medium
          semgrep --config=auto v13/ --json -o semgrep_report.json --error

      - name: Upload Analysis Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: static-analysis-reports
          path: |
            violation_report.json
            bandit_report.json
            semgrep_report.json
          retention-days: 30

  # ============================================================================
  # Stage 2: Unit Tests
  # ============================================================================
  unit-tests:
    name: Unit Tests (Enhanced Logging)
    needs: static-analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov hypothesis

      - name: Run Unit Tests
        run: |
          python -m pytest v13/tests/unit/ \
            -v \
            --tb=long \
            --log-cli-level=DEBUG \
            --cov=v13 \
            --cov-report=xml:coverage.xml \
            --cov-report=term \
            --junitxml=test-results.xml

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            coverage.xml
            test-results.xml
            v13/evidence/logs/
          retention-days: 30

  # ============================================================================
  # Stage 3: Determinism Fuzzer (Phase 3)
  # ============================================================================
  determinism-fuzzer:
    name: Deterministic Replay Verification
    needs: unit-tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Determinism Fuzzer
        run: |
          # Use paths in root 'tests' if they exist, otherwise check v13/tests
          if [ -f "tests/phase3_verification_suite.py" ]; then
             python tests/phase3_verification_suite.py
          elif [ -f "v13/tests/phase3_verification_suite.py" ]; then
             python v13/tests/phase3_verification_suite.py
          else
             echo "⚠️ Phase 3 Verification Suite not found, skipping"
          fi

  # ============================================================================
  # Stage 4: Integration & PQC
  # ============================================================================
  integration-tests:
    name: Integration & PQC Verification
    needs: determinism-fuzzer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Integration Tests
        run: |
          python -m pytest v13/tests/integration/ -v --tb=short

      - name: Run PQC Verification
        run: |
          if [ -f "v13/tests/test_pqc.py" ]; then
             python -m pytest v13/tests/test_pqc.py -v
          fi

      - name: Run Deterministic Replay Test
        run: |
          if [ -f "v13/tests/test_deterministic_replay.py" ]; then
             python v13/tests/test_deterministic_replay.py
          fi
