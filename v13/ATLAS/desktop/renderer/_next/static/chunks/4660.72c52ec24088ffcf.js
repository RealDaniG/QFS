"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4660],{94660:function(e,t,n){n.d(t,{MessageCommitter:function(){return d}});var a=n(49265),r=n(23883);async function i(e,t,n,r){let i=n&&n.length>0?n:void 0;return a.Ascon.encrypt(e,t,r,i)}async function c(e,t,n,r){try{let i=n&&n.length>0?n:void 0;return a.Ascon.decrypt(e,t,r,i)}catch(e){return console.error("Ascon decryption failed:",e),null}}function s(e){return new TextEncoder().encode(e)}function o(e){if(e.length%2!=0)throw Error("Invalid hex string");let t=new Uint8Array(e.length/2);for(let n=0;n<e.length;n+=2)t[n/2]=parseInt(e.substring(n,n+2),16);return t}function l(e){return Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}class h{async createEnvelope(e,t,n,a,c){let o=s(y(n)),h=(0,r.sha3_256)(o),d=s("".concat(e,":").concat(this.clientSeqCounter)),p=new Uint8Array(r.sha3_256.array(d).slice(0,16)),u=await i(c,p,new Uint8Array(0),o),_=s(y({space_id:e,sender_pubkey:t,payload_hash:h,intent:a,client_seq:this.clientSeqCounter})),f=function(e,t){r.shake256.create(256);let n=new Uint8Array(e.length+t.length);return n.set(e),n.set(t,e.length),new Uint8Array(r.shake256.array(n,512))}(this.walletPrivateKey,_);return this.clientSeqCounter++,{space_id:e,sender_pubkey:t,payload_ciphertext:l(u),payload_hash:h,intent:a,signature:l(f),client_seq:this.clientSeqCounter-1}}static verifyEnvelope(e){return s(y({space_id:e.space_id,sender_pubkey:e.sender_pubkey,payload_hash:e.payload_hash,intent:e.intent,client_seq:e.client_seq})),o(e.signature),!0}async decryptPayload(e,t){let n=s("".concat(e.space_id,":").concat(e.client_seq)),a=new Uint8Array(r.sha3_256.array(n).slice(0,16));console.log("[Debug] TS Nonce: ".concat(l(a)));let i=o(e.payload_ciphertext),h=await c(t,a,new Uint8Array(0),i);if(!h)throw Error("Decryption failed: Integrity check or key incorrect");let y=JSON.parse(new TextDecoder().decode(h)),d=(0,r.sha3_256)(h);if(d!==e.payload_hash)throw Error("Payload hash mismatch. Expected ".concat(e.payload_hash,", got ").concat(d));return y}stringifyDeterministic(e){let t=[];return JSON.stringify(e,(e,n)=>(t.push(e),n)),JSON.stringify(e,Object.keys(e).sort())}constructor(e){this.walletPrivateKey=o(e),this.clientSeqCounter=0}}function y(e){return null===e||"object"!=typeof e?JSON.stringify(e):Array.isArray(e)?"["+e.map(y).join(",")+"]":"{"+Object.keys(e).sort().map(t=>JSON.stringify(t)+":"+y(e[t])).join(",")+"}"}class d{async createAndCommit(e,t,n,a){let r=await this.factory.createEnvelope(this.spaceId,e,t,n,this.sessionKey),i=await this.commitToBackend(r,a);return{envelope:r,evidenceHash:i}}async commitToBackend(e,t){let n=await fetch("".concat(this.backendUrl,"/api/evidence/commit"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},body:JSON.stringify({event_type:"SPACE_MESSAGE_COMMIT",space_id:e.space_id,sender:e.sender_pubkey,payload_hash:e.payload_hash,intent:e.intent,client_seq:e.client_seq})});if(!n.ok){let e=await n.text();throw Error("Failed to commit message: ".concat(n.statusText," - ").concat(e))}let{evidence_hash:a}=await n.json();return a}async fetchMissingMessages(e,t,n){let a=await fetch("".concat(this.backendUrl,"/api/evidence/sync?space_id=").concat(e,"&since=").concat(t),{method:"GET",headers:{Authorization:"Bearer ".concat(n)}});if(!a.ok)throw Error("Failed to sync messages: ".concat(a.statusText));return await a.json()}constructor(e="http://localhost:8000",t,n,a){this.backendUrl=e,this.factory=new h(t),this.spaceId=n,this.sessionKey=a}}}}]);