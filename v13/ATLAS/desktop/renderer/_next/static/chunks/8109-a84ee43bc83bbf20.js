"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8109],{23340:function(e,t,n){n.d(t,{pm:function(){return y}});var r=n(2265);let s=0,a=new Map,o=e=>{if(a.has(e))return;let t=setTimeout(()=>{a.delete(e),u({type:"REMOVE_TOAST",toastId:e})},1e6);a.set(e,t)},i=(e,t)=>{switch(t.type){case"ADD_TOAST":return{...e,toasts:[t.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===t.toast.id?{...e,...t.toast}:e)};case"DISMISS_TOAST":{let{toastId:n}=t;return n?o(n):e.toasts.forEach(e=>{o(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===n||void 0===n?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===t.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==t.toastId)}}},c=[],l={toasts:[]};function u(e){l=i(l,e),c.forEach(e=>{e(l)})}function h(e){let{...t}=e,n=(s=(s+1)%Number.MAX_SAFE_INTEGER).toString(),r=()=>u({type:"DISMISS_TOAST",toastId:n});return u({type:"ADD_TOAST",toast:{...t,id:n,open:!0,onOpenChange:e=>{e||r()}}}),{id:n,dismiss:r,update:e=>u({type:"UPDATE_TOAST",toast:{...e,id:n}})}}function y(){let[e,t]=r.useState(l);return r.useEffect(()=>(c.push(t),()=>{let e=c.indexOf(t);e>-1&&c.splice(e,1)}),[e]),{...e,toast:h,dismiss:e=>u({type:"DISMISS_TOAST",toastId:e})}}},48109:function(e,t,n){n.d(t,{G:function(){return w},m:function(){return A}});var r=n(57437),s=n(2265),a=n(32038),o=n(23883),i=n(49265);async function c(e,t,n,r){let s=n&&n.length>0?n:void 0;return i.Ascon.encrypt(e,t,r,s)}async function l(e,t,n,r){try{let s=n&&n.length>0?n:void 0;return i.Ascon.decrypt(e,t,r,s)}catch(e){return console.error("Ascon decryption failed:",e),null}}function u(e){return new TextEncoder().encode(e)}function h(e){if(e.length%2!=0)throw Error("Invalid hex string");let t=new Uint8Array(e.length/2);for(let n=0;n<e.length;n+=2)t[n/2]=parseInt(e.substring(n,n+2),16);return t}function y(e){return Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}async function d(e,t,n,r){let s=h(n),a=u(e),i=u(t),c=u(r),l=new Uint8Array(a.length+i.length+s.length+c.length),y=0;return l.set(a,y),y+=a.length,l.set(i,y),y+=i.length,l.set(s,y),y+=s.length,l.set(c,y),y+=c.length,new Uint8Array(o.sha3_256.array(l))}class p{async createEnvelope(e,t,n,r,s){let a=u(f(n)),i=(0,o.sha3_256)(a),l=u("".concat(e,":").concat(this.clientSeqCounter)),h=new Uint8Array(o.sha3_256.array(l).slice(0,16)),d=await c(s,h,new Uint8Array(0),a),p=u(f({space_id:e,sender_pubkey:t,payload_hash:i,intent:r,client_seq:this.clientSeqCounter})),_=function(e,t){o.shake256.create(256);let n=new Uint8Array(e.length+t.length);return n.set(e),n.set(t,e.length),new Uint8Array(o.shake256.array(n,512))}(this.walletPrivateKey,p);return this.clientSeqCounter++,{space_id:e,sender_pubkey:t,payload_ciphertext:y(d),payload_hash:i,intent:r,signature:y(_),client_seq:this.clientSeqCounter-1}}static verifyEnvelope(e){let t=u(f({space_id:e.space_id,sender_pubkey:e.sender_pubkey,payload_hash:e.payload_hash,intent:e.intent,client_seq:e.client_seq})),n=h(e.signature);return function(e,t,n){let r=new Uint8Array(e.length+t.length);r.set(e),r.set(t,e.length);let s=new Uint8Array(o.shake256.array(r,512));if(n.length!==s.length)return!1;for(let e=0;e<n.length;e++)if(n[e]!==s[e])return!1;return!0}(h(e.sender_pubkey),t,n)}async decryptPayload(e,t){let n=u("".concat(e.space_id,":").concat(e.client_seq)),r=new Uint8Array(o.sha3_256.array(n).slice(0,16));console.log("[Debug] TS Nonce: ".concat(y(r)));let s=h(e.payload_ciphertext),a=await l(t,r,new Uint8Array(0),s);if(!a)throw Error("Decryption failed: Integrity check or key incorrect");let i=JSON.parse(new TextDecoder().decode(a)),c=(0,o.sha3_256)(a);if(c!==e.payload_hash)throw Error("Payload hash mismatch. Expected ".concat(e.payload_hash,", got ").concat(c));return i}stringifyDeterministic(e){let t=[];return JSON.stringify(e,(e,n)=>(t.push(e),n)),JSON.stringify(e,Object.keys(e).sort())}constructor(e){this.walletPrivateKey=h(e),this.clientSeqCounter=0}}function f(e){return null===e||"object"!=typeof e?JSON.stringify(e):Array.isArray(e)?"["+e.map(f).join(",")+"]":"{"+Object.keys(e).sort().map(t=>JSON.stringify(t)+":"+f(e[t])).join(",")+"}"}class _{setSessionKey(e){this.sessionKey=e}async initialize(e,t){}async prepareMessage(e,t,n,r){return this.sessionKey||(this.sessionKey=await d(n,e,r.session_nonce,r.evidence_head)),this.factory.createEnvelope(e,n,t,"chat.message",this.sessionKey)}async decrypt(e){if(!this.sessionKey)throw Error("Session key not initialized");return this.factory.decryptPayload(e,this.sessionKey)}constructor(e){this.walletPrivateKey=e,this.sessionKey=null,this.factory=new p(e)}}var S=n(23340);let g=(0,s.createContext)(null);function w(e){let{children:t}=e,{sessionToken:n,address:o}=(0,a.i)(),[i,c]=(0,s.useState)(!1),[l,u]=(0,s.useState)(null),[h,y]=(0,s.useState)([]),[p,f]=(0,s.useState)(null),{toast:w}=(0,S.pm)(),A=(0,s.useRef)(null),E=(0,s.useRef)(null),P=(0,s.useRef)(null),T=(0,s.useRef)(null);(0,s.useEffect)(()=>{if(o){let e=o.toLowerCase().replace("0x","").padEnd(64,"0");P.current=new _(e)}},[o]);let v=(0,s.useCallback)(async e=>{if(!n||!o){console.warn("Cannot connect to P2P: No session");return}try{let t="http://localhost:3000",r=await fetch("".concat(t,"/api/p2p/session?space_id=").concat(e),{headers:{Authorization:"Bearer ".concat(n)}});if(!r.ok)throw Error("Failed to get P2P session params");let s=await r.json();T.current=s,f(s.evidence_head);let a=await d(s.wallet_address,e,s.session_nonce,s.evidence_head);E.current=a,P.current&&P.current.setSessionKey(a),console.log("[P2P] Derived session key for ".concat(e)),A.current&&A.current.close();let o=t.replace("http","ws")+"/api/p2p/ws/".concat(e),i=new WebSocket(o);i.onopen=()=>{console.log("[P2P] Connected to ".concat(e)),c(!0),u(e),w({title:"Connected to Secure Space",description:"Session established for ".concat(e)})},i.onmessage=async e=>{try{let t=JSON.parse(e.data);if(P.current&&E.current){let e=await P.current.decrypt(t);y(t=>[...t,e])}}catch(e){console.error("WS Message handling error",e)}},i.onclose=()=>{c(!1),u(null)},A.current=i}catch(e){console.error("P2P Connection failed",e),w({variant:"destructive",title:"Connection Failed",description:"Could not establish secure P2P link"})}},[n,o,w]),k=async e=>{if(A.current&&P.current&&T.current&&l)try{let t=await P.current.prepareMessage(l,e,o.toLowerCase().replace("0x","").padEnd(64,"0"),T.current);A.current.send(JSON.stringify(t)),y(t=>[...t,e])}catch(e){console.error("Send failed",e)}};return(0,r.jsx)(g.Provider,{value:{isConnected:i,currentSpaceId:l,messages:h,connectToSpace:v,sendMessage:k,evidenceHead:p},children:t})}function A(){let e=(0,s.useContext)(g);if(!e)throw Error("useP2P must be used within P2PProvider");return e}}}]);