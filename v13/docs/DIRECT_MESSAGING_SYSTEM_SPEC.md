# QFS Ã— ATLAS: Direct Messaging System (DMS) Specification

**Version:** 1.0
**Status:** DRAFT
**Scope:** P0 (Gap Analysis)

## 1. Purpose & Scope

The Direct Messaging System (DMS) provides a secure, coherent, and verifiable channel for user-to-user communication within the ATLAS platform.
It leverages QFS for:

- Identity verification (ATLAS ID)
- Reputation gating (AEGIS/Coherence checks)
- Spam/Abuse prevention (Ledger-backed costs/limits)
- End-to-End Encryption (PQC-ready key exchange)

**Out of Scope (V1):**

- Group chats
- File transfers > 1MB
- Cross-chain bridging of messages

## 2. Core Constraints

1. **Zero-Simulation**: No messages are stored or generated by "simulated" agents. All senders must be registered ATLAS identities.
2. **Reputation Gating**: Users below a certain Coherence Score (e.g., 300) cannot initiate new conversations with strangers, only reply.
3. **Auditability**: Metadata (Sender, Recipient, Timestamp, Hash) is logged to the QFS Event Ledger. Content is *never* logged to the ledger in plaintext.
4. **Ephemeral Storage**: Message content is stored in the Decentralized Storage (IPFS/OrbitDB) pinned by the participating nodes, not on the blockchain directly.

## 3. Functional Requirements

### 3.1 Signaling & Discovery

- Users publish a **Public Identity Bundle** containing:
  - Public Encryption Key (PQC Dilithium/Kyber hybrid)
  - Inbox Address (Storage pointer)
  - Coherence Proof (Signed by AEGIS)
- Lookup happens via `AtlasDirectory`.

### 3.2 Message Flow

1. **Compose**: Sender creates message locally.
2. **Encrypt**: Message body encrypted with Recipient's Public Key.
3. **Sign**: Encrypted blob signed with Sender's Private Key.
4. **Store**: Blob uploaded to temporary storage (TTL 30 days).
5. **Signal**: `MESSAGE_SENT` event emitted to QFS Ledger (or Interactions Bridge).
    - Contains: `hash(blob)`, `recipient_id`, `timestamp`.
6. **Receive**: Recipient listens for `MESSAGE_SENT` addressing them.
7. **Fetch & Decrypt**: Recipient retrieves blob, verifies signature, decrypts.

### 3.3 Anti-Abuse (AEGIS Integrated)

- **Rate Limiting**: Max 10 new conversations per day per user.
- **Blocklist**: Deterministic block preferences stored in user's request context.
- **Reporting**: "Report Spam" creates a `MODERATION_APPEAL` event pointing to the message hash.

## 4. Data Models

### 4.1 Message Object (Off-Ledger)

```json
{
  "id": "uuid",
  "sender_id": "atlas_did:...",
  "recipient_id": "atlas_did:...",
  "timestamp": "iso8601",
  "content_type": "text/plain",
  "content_ciphertext": "base64...",
  "signature": "hex...",
  "pqc_algo": "kyber512"
}
```

### 4.2 Application Event (On-Ledger)

```json
{
  "event_type": "DM_SIGNAL",
  "sender": "0x...",
  "recipient": "0x...",
  "msg_hash": "sha256...",
  "storage_ref": "ipfs://..."
}
```

## 5. Security Considerations

- **Metadata Leakage**: The ledger reveals *who* matches with *whom* and *when*. This is acceptable for V1 but clearly documented.
- **Forward Secrecy**: V1 keys are static. V2 will implement ratchet mechanism (Double Ratchet).
- **Key Rotation**: Users can rotate keys by publishing a new Identity Bundle. Old messages may become unreadable if keys are lost.

## 6. Implementation Plan

- [ ] **Phase 1**: APIs for Identity Bundle publication.
- [ ] **Phase 2**: Crypto module for Encrypt/Decrypt/Sign.
- [ ] **Phase 3**: Storage bridge implementation.
- [ ] **Phase 4**: UI Integration in ATLAS.
