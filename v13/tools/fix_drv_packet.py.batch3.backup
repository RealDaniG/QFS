import os


def fix_drv_packet():
    file_path = "v13/core/DRV_Packet.py"
    with open(file_path, "r", encoding="utf-8") as f:
        lines = f.readlines()

    new_lines = []
    state = "NORMAL"  # NORMAL, HEAD_BLOCK, IGNORE_BLOCK

    for line in lines:
        stripped = line.strip()
        if stripped.startswith("<<<<<<< HEAD"):
            state = "HEAD_BLOCK"
            continue
        elif stripped.startswith("======="):
            if state == "HEAD_BLOCK":
                state = "IGNORE_BLOCK"
            elif state == "NORMAL":
                # Orphaned ======= ?
                # Just ignore it if it looks like a marker
                pass
            continue
        elif stripped.startswith(">>>>>>>"):
            if state == "IGNORE_BLOCK":
                state = "NORMAL"
            elif state == "HEAD_BLOCK":
                # Should not happen usually, but if HEAD block ends with >>> (orphan), switch
                state = "NORMAL"
            continue

        if state == "NORMAL":
            new_lines.append(line)
        elif state == "HEAD_BLOCK":
            new_lines.append(line)
        elif state == "IGNORE_BLOCK":
            pass

    with open(file_path, "w", encoding="utf-8") as f:
        f.writelines(new_lines)

    print(f"Fixed {file_path}")


if __name__ == "__main__":
    fix_drv_packet()
